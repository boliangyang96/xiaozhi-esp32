# UART串口通信控制器

## 概述

本UART控制器实现了通过MCP协议与外部MCU进行串口通信的功能，主要用于控制AI桌面空净星空灯设备。该设备集成了空气净化器和多种灯光系统（四色灯、激光灯、投影灯）。控制器使用GPIO 17作为TXD端口，GPIO 18作为RXD端口，波特率为9600。

**重要更新**: 控制器现在支持多帧数据处理，MCU会一次性上报所有DP数据，系统会自动分割和处理多个连续的数据帧。

## 协议规范

### 串口配置
- 波特率: 9600
- 数据位: 8
- 奇偶校验: 无
- 停止位: 1
- 数据流控: 无

### 通信协议

#### 数据帧格式
```
帧头(2字节) + 版本(1字节) + 命令字(1字节) + 数据长度(2字节) + 数据 + 校验和(1字节)
```

#### 协议常量
- 帧头: 0x55AA
- 模块发送版本: 0x00
- MCU上报版本: 0x03
- 控制命令: 0x06
- 上报命令: 0x07
- 查询状态命令: 0x08

#### 多帧数据处理
MCU会一次性上报所有DP数据，包含多个连续的数据帧，例如：
```
55 AA 03 07 00 05 01 01 00 01 01 12  // 开关控制
55 AA 03 07 00 08 02 02 00 04 00 00 00 00 19  // PM2.5数值
55 AA 03 07 00 05 03 04 00 01 00 16  // 模式设置
... (更多DP数据帧)
```

系统会自动：
1. 接收所有上报数据
2. 根据帧头(0x55 0xAA)和版本号(0x03)分割多个数据帧
3. 独立验证每个数据帧的校验和
4. 解析每个DP数据并更新设备状态

## 功能特性

### 空气净化器控制功能
1. **开关控制** - 开启/关闭空气净化器
2. **模式设置** - 设置运行模式（睡眠/自动/快速/手动）
3. **风速控制** - 设置风扇速度（低/中/高）
4. **负离子控制** - 启用/禁用负离子功能
5. **童锁控制** - 启用/禁用童锁功能
6. **杀菌灯控制** - 开启/关闭UV杀菌灯
7. **定时设置** - 设置定时器（1小时/2小时/4小时/6小时/取消）

### 灯光系统控制功能
1. **四色灯亮度控制** - 设置白光亮度（1-100）
2. **四色灯开关** - 开启/关闭四色LED灯
3. **四色灯呼吸效果** - 开启/关闭四色LED灯呼吸效果
4. **四色灯场景模式** - 设置16种预设场景（月影、极光、黄昏、深蓝、森林、篝火、黎明、星空、日落、寺庙烛光、水墨、赛博朋克、浪漫、治愈、专注、彩虹）+ 1个自定义
5. **四色灯颜色设置** - 使用HSV色彩模式精确设置颜色（色调0-360°，饱和度0-100%，亮度0-100%）
6. **激光灯模式控制** - 设置激光灯模式（常亮/呼吸/关闭）
7. **投影灯模式控制** - 设置投影灯模式（常亮/呼吸/关闭）

### 状态查询功能
1. **完整设备状态查询** - 获取空气净化器和灯光的所有设备状态信息，包括：
   - 净化器开关状态
   - 室内PM2.5数值
   - 净化器模式设置状态
   - 净化器风速状态
   - 净化器滤网寿命
   - 负离子状态
   - 净化器童锁状态
   - 净化器杀菌灯状态
   - 室内温度
   - 室内湿度
   - 净化器定时状态
   - 室内空气质量
   - 四色灯亮度
   - 四色灯开关状态
   - 四色灯呼吸效果状态
   - 四色灯场景模式
   - 四色灯颜色（HSV值）
   - 激光灯模式
   - 投影灯模式

## MCP工具接口

### 空气净化器控制工具
- `self.air_purifier.set_switch` - 控制净化器开关
- `self.air_purifier.set_mode` - 设置净化器模式
- `self.air_purifier.set_fan_speed` - 设置净化器风速
- `self.air_purifier.set_anion` - 设置负离子开关
- `self.air_purifier.set_child_lock` - 设置童锁
- `self.air_purifier.set_uv_light` - 设置杀菌灯
- `self.air_purifier.set_countdown` - 设置定时器

### 灯光系统控制工具
- `self.light.set_brightness` - 设置四色灯白光亮度
- `self.light.set_led_switch` - 设置四色LED灯开关
- `self.light.set_led_breath_switch` - 设置四色LED呼吸效果开关
- `self.light.set_led_scene` - 设置四色LED场景模式
- `self.light.set_led_colour` - 设置四色LED颜色（HSV格式）
- `self.light.set_laser_mode` - 设置激光灯模式
- `self.light.set_projection_mode` - 设置投影灯模式

### 状态查询工具
- `self.air_purifier_or_light.get_status` - 获取完整设备状态，包括净化器所有状态和灯光系统所有状态信息

## 使用示例

### 通过MCP控制设备
```json
{
  "tool": "self.air_purifier.set_switch",
  "arguments": {
    "state": true
  }
}
```

### 查询设备状态
```json
{
  "tool": "self.air_purifier_or_light.get_status",
  "arguments": {}
}
```

### 设置运行模式
```json
{
  "tool": "self.air_purifier.set_mode",
  "arguments": {
    "mode": 1
  }
}
```

### 设置LED颜色
```json
{
  "tool": "self.light.set_led_colour",
  "arguments": {
    "hue": 220,
    "saturation": 75,
    "value": 78
  }
}
```

### 设置灯光场景
```json
{
  "tool": "self.light.set_led_scene",
  "arguments": {
    "scene": 7
  }
}
```

## 模式定义

### 运行模式
- 0: 睡眠模式
- 1: 自动模式
- 2: 快速模式
- 3: 手动模式

### 风速等级
- 0: 低速
- 1: 中速
- 2: 高速

### 空气质量等级
- 0: 优秀
- 1: 中等
- 2: 严重

### 定时设置
- 0: 1小时
- 1: 2小时
- 2: 4小时
- 3: 6小时
- 4: 取消定时

### 灯光场景模式
- 0: 月影 (moon_shadow)
- 1: 极光 (aurora)
- 2: 黄昏 (dusk)
- 3: 深蓝 (deep_blue)
- 4: 森林 (forest)
- 5: 篝火 (bonfire)
- 6: 黎明 (early_dawn)
- 7: 星空 (starry_sky)
- 8: 日落 (sunset)
- 9: 寺庙烛光 (temple_candle)
- 10: 水墨 (ink_wash)
- 11: 赛博朋克 (cyberpunk)
- 12: 浪漫 (romance)
- 13: 治愈 (healing)
- 14: 专注 (focus)
- 15: 彩虹 (rainbow)
- 16: 自定义 (custom)

### 激光灯和投影灯模式
- 0: 常亮 (on)
- 1: 呼吸 (breath)
- 2: 关闭 (off)

### HSV颜色格式说明
- **色调 (Hue)**: 0-360度，表示颜色在色环中的位置
- **饱和度 (Saturation)**: 0-100%，表示颜色的纯度
- **亮度值 (Value)**: 0-100%，表示颜色的明暗程度

**示例**: 设置蓝色
- 色调: 220度 (蓝色区域)
- 饱和度: 75% (较高饱和度)
- 亮度: 78% (中等亮度)

## 错误处理

控制器包含完整的错误处理机制：
- 串口通信错误检测
- 数据帧校验和验证
- 超时处理
- 状态初始化检查
- **多帧数据完整性检查**
- **智能错误恢复机制**：遇到异常数据帧时，会跳过错误帧，继续寻找下一个有效的帧头，而不是退出解析
- **部分帧损坏容错**：系统可以在部分帧损坏的情况下继续处理其他有效帧
- **灵活的成功标准**：只要解析到至少一个有效数据帧，就认为解析成功

## 调试信息

控制器会输出详细的调试日志，包括：
- 数据帧发送/接收状态
- 设备状态变化
- 错误信息
- 通信协议解析结果
- **新增：多帧解析过程日志**
- **新增：每个数据帧的验证结果**

## 技术改进

### 多帧数据处理
1. **ReceiveMultiFrames**: 接收MCU上报的所有数据
2. **ParseMultiFrames**: 解析多个连续的数据帧
3. **自动分割**: 根据帧头自动分割多个数据帧
4. **独立验证**: 每个数据帧独立验证校验和
5. **协议常量**: 使用FRAME_HEADER等常量，避免硬编码

### 性能优化
- 使用vector容器管理多帧数据
- 支持任意数量的DP数据帧
- **智能错误恢复机制**：遇到异常数据时自动跳过并继续寻找有效帧
- **增强的容错能力**：部分帧损坏不影响其他帧处理
- **灵活的解析策略**：只要有一个有效帧即认为解析成功
- 详细的调试日志便于问题排查

## 注意事项

1. 确保外部MCU正确连接到GPIO 17和GPIO 18
2. 外部MCU必须支持相同的通信协议
3. 首次使用前建议先调用状态查询功能
4. 控制命令发送后建议查询状态确认执行结果
5. 如果通信失败，检查串口连接和协议兼容性
6. **MCU会一次性上报所有DP数据，系统会自动处理多帧数据**
7. **系统具备智能错误恢复能力，遇到异常数据时会跳过并继续处理后续有效帧**
8. **解析过程采用容错设计，部分帧损坏不影响整体数据处理**