# WiFi 自动联网功能测试指南

## 概述
本测试指南用于验证新的 WiFi 自动联网功能，该功能允许设备通过 API 获取 WiFi 凭据并自动连接，无需用户手动配网。

## 测试环境准备

### 1. 硬件要求
- ESP32 开发板
- 多个不同的 WiFi 路由器（用于测试不同网络）
- 网络分析工具（可选）

### 2. 软件要求
- ESP-IDF 开发环境
- 串口调试工具
- WiFi 分析工具

## 测试用例

### 测试用例 1：正常 WiFi 连接
**目标**：验证基本功能正常工作

**步骤**：
1. 修改 `main/wifi_pre_connect.cc` 中的 `current_test_case = TEST_NORMAL_WIFI`
2. 编译并烧录程序
3. 观察串口日志
4. 验证设备是否成功连接 WiFi

**预期结果**：
```
I (xxx) wifi_pre_connect: [测试] 正常WiFi连接
I (xxx) wifi_pre_connect: 获取到WiFi凭据: SSID=antop-r02
I (xxx) wifi_pre_connect: 保存WiFi凭据到SsidManager: SSID=antop-r02
I (xxx) WifiBoard: 启动WifiStation，将使用SsidManager中的凭据连接
```

**成功标准**：
- 设备成功连接 WiFi
- 没有进入配网模式
- 应用正常启动

### 测试用例 2：空凭据处理
**目标**：验证当 API 返回空凭据时的行为

**步骤**：
1. 修改 `current_test_case = TEST_EMPTY_CREDENTIALS`
2. 编译并烧录程序
3. 观察串口日志

**预期结果**：
```
I (xxx) wifi_pre_connect: [测试] 空凭据 - 应该进入配网模式
I (xxx) wifi_pre_connect: 未获取到有效的WiFi账号或密码，跳过自动联网
I (xxx) WifiConfigurationAp: Access Point started with SSID Xiaozhi-xxx
```

**成功标准**：
- 设备进入配网模式
- 显示配网提示信息

### 测试用例 3：无效 WiFi 处理
**目标**：验证当 WiFi 连接失败时的行为

**步骤**：
1. 修改 `current_test_case = TEST_INVALID_WIFI`
2. 编译并烧录程序
3. 观察串口日志

**预期结果**：
- 设备尝试连接无效 WiFi
- 连接失败后进入配网模式

### 测试用例 4：特殊字符处理
**目标**：验证特殊字符的 WiFi 名称和密码

**步骤**：
1. 修改 `current_test_case = TEST_SPECIAL_CHARS`
2. 在路由器上创建对应的 WiFi 网络
3. 编译并烧录程序
4. 观察连接结果

**成功标准**：
- 设备能正确处理特殊字符
- 成功连接到包含特殊字符的 WiFi

### 测试用例 5：中文 SSID 处理
**目标**：验证中文 WiFi 名称的支持

**步骤**：
1. 修改 `current_test_case = TEST_CHINESE_SSID`
2. 在路由器上创建中文名称的 WiFi 网络
3. 编译并烧录程序
4. 观察连接结果

### 测试用例 6：长凭据处理
**目标**：验证超长 SSID 和密码的处理

**步骤**：
1. 修改 `current_test_case = TEST_LONG_CREDENTIALS`
2. 在路由器上创建长名称的 WiFi 网络
3. 编译并烧录程序
4. 观察连接结果

## 网络断开测试

### 测试场景 1：WiFi 信号中断
**步骤**：
1. 设备正常连接 WiFi
2. 手动关闭路由器或移动设备远离路由器
3. 观察设备的重连行为

**预期结果**：
- 设备检测到网络断开
- 尝试重新连接
- 如果重连失败，可能进入配网模式

### 测试场景 2：路由器重启
**步骤**：
1. 设备正常连接 WiFi
2. 重启路由器
3. 观察设备在路由器恢复后的行为

**预期结果**：
- 设备在路由器重启期间断开连接
- 路由器恢复后，设备自动重连

## 兼容性测试

### 测试场景 1：与手动配网兼容
**步骤**：
1. 清除设备上所有保存的 WiFi 信息
2. 重启设备
3. 通过配网模式手动配置 WiFi
4. 验证手动配置的 WiFi 是否正常工作

**成功标准**：
- 手动配网功能正常工作
- 手动配置的 WiFi 能正常连接

### 测试场景 2：多设备同时使用
**步骤**：
1. 准备多个相同的设备
2. 同时启动所有设备
3. 观察网络冲突情况

**成功标准**：
- 所有设备都能正常连接
- 没有网络冲突

## 性能测试

### 测试场景 1：启动时间
**步骤**：
1. 测量设备从启动到连接 WiFi 的时间
2. 与手动配网模式对比

**预期结果**：
- 自动联网模式应该比手动配网更快

### 测试场景 2：内存使用
**步骤**：
1. 监控自动联网功能的内存使用情况
2. 与手动配网模式对比

**成功标准**：
- 内存使用在合理范围内
- 没有内存泄漏

## 错误处理测试

### 测试场景 1：API 调用失败
**步骤**：
1. 模拟 API 调用超时
2. 模拟 API 返回错误
3. 观察设备的错误处理

### 测试场景 2：网络配置错误
**步骤**：
1. 提供错误的 WiFi 密码
2. 提供不存在的 SSID
3. 观察错误处理

## 测试报告模板

### 测试结果记录
```
测试用例：[用例名称]
测试日期：[日期]
测试人员：[姓名]
测试结果：[通过/失败]
问题描述：[如有问题，详细描述]
日志片段：[关键日志]
```

### 问题跟踪
- 问题编号：[编号]
- 问题描述：[描述]
- 严重程度：[高/中/低]
- 状态：[新建/修复中/已修复]
- 修复方案：[修复方案]

## 注意事项

1. **测试前准备**：
   - 确保测试环境稳定
   - 准备多个不同的 WiFi 网络
   - 记录测试前的设备状态

2. **测试过程中**：
   - 详细记录所有日志
   - 拍照或录像记录关键步骤
   - 及时记录发现的问题

3. **测试后清理**：
   - 恢复设备到初始状态
   - 清理测试数据
   - 整理测试报告

## 常见问题排查

### 问题 1：设备无法连接 WiFi
**可能原因**：
- WiFi 凭据错误
- 网络信号弱
- 路由器配置问题

**排查步骤**：
1. 检查 WiFi 凭据是否正确
2. 检查网络信号强度
3. 检查路由器设置

### 问题 2：设备一直进入配网模式
**可能原因**：
- SsidManager 没有正确保存凭据
- WifiStation 连接失败
- force_ap 标志设置错误

**排查步骤**：
1. 检查 SsidManager 是否保存了凭据
2. 检查 WifiStation 连接日志
3. 检查 NVS 中的 force_ap 设置

### 问题 3：连接成功但应用无法正常工作
**可能原因**：
- 网络配置问题
- DNS 解析问题
- 应用依赖的网络服务不可用

**排查步骤**：
1. 检查网络连接状态
2. 检查 DNS 设置
3. 检查应用日志