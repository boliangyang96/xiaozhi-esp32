# UART串口通信控制器

## 概述

本UART控制器实现了通过MCP协议与外部MCU进行串口通信的功能，主要用于控制空气净化器设备。控制器使用GPIO 17作为TXD端口，GPIO 18作为RXD端口，波特率为9600。

**重要更新**: 控制器现在支持多帧数据处理，MCU会一次性上报所有DP数据，系统会自动分割和处理多个连续的数据帧。

## 协议规范

### 串口配置
- 波特率: 9600
- 数据位: 8
- 奇偶校验: 无
- 停止位: 1
- 数据流控: 无

### 通信协议

#### 数据帧格式
```
帧头(2字节) + 版本(1字节) + 命令字(1字节) + 数据长度(2字节) + 数据 + 校验和(1字节)
```

#### 协议常量
- 帧头: 0x55AA
- 模块发送版本: 0x00
- MCU上报版本: 0x03
- 控制命令: 0x06
- 上报命令: 0x07
- 查询状态命令: 0x08

#### 多帧数据处理
MCU会一次性上报所有DP数据，包含多个连续的数据帧，例如：
```
55 AA 03 07 00 05 01 01 00 01 01 12  // 开关控制
55 AA 03 07 00 08 02 02 00 04 00 00 00 00 19  // PM2.5数值
55 AA 03 07 00 05 03 04 00 01 00 16  // 模式设置
... (更多DP数据帧)
```

系统会自动：
1. 接收所有上报数据
2. 根据帧头(0x55 0xAA)和版本号(0x03)分割多个数据帧
3. 独立验证每个数据帧的校验和
4. 解析每个DP数据并更新设备状态

## 功能特性

### 设备控制功能
1. **开关控制** - 开启/关闭空气净化器
2. **模式设置** - 设置运行模式（睡眠/自动/快速/手动）
3. **风速控制** - 设置风扇速度（低/中/高）
4. **童锁控制** - 启用/禁用童锁功能
5. **杀菌灯控制** - 开启/关闭UV杀菌灯
6. **定时设置** - 设置定时器（1小时/2小时/4小时/6小时/取消）

### 状态查询功能
1. **PM2.5查询** - 获取当前PM2.5数值
2. **温度查询** - 获取室内温度
3. **湿度查询** - 获取室内湿度
4. **空气质量查询** - 获取空气质量等级
5. **滤网剩余查询** - 获取滤网剩余寿命百分比
6. **设备状态查询** - 获取所有设备状态信息

## MCP工具接口

### 控制工具
- `self.air_purifier.set_switch` - 控制开关
- `self.air_purifier.set_mode` - 设置模式
- `self.air_purifier.set_fan_speed` - 设置风速
- `self.air_purifier.set_child_lock` - 设置童锁
- `self.air_purifier.set_uv_light` - 设置杀菌灯
- `self.air_purifier.set_countdown` - 设置定时

### 查询工具
- `self.air_purifier.get_status` - 获取完整设备状态
- `self.air_purifier.get_pm25` - 查询PM2.5
- `self.air_purifier.get_temperature` - 查询温度
- `self.air_purifier.get_humidity` - 查询湿度
- `self.air_purifier.get_air_quality` - 查询空气质量
- `self.air_purifier.get_filter_life` - 查询滤网寿命

## 使用示例

### 通过MCP控制设备
```json
{
  "tool": "self.air_purifier.set_switch",
  "arguments": {
    "state": true
  }
}
```

### 查询设备状态
```json
{
  "tool": "self.air_purifier.get_status",
  "arguments": {}
}
```

### 设置运行模式
```json
{
  "tool": "self.air_purifier.set_mode",
  "arguments": {
    "mode": 1
  }
}
```

## 模式定义

### 运行模式
- 0: 睡眠模式
- 1: 自动模式
- 2: 快速模式
- 3: 手动模式

### 风速等级
- 0: 低速
- 1: 中速
- 2: 高速

### 空气质量等级
- 0: 优秀
- 1: 中等
- 2: 严重

### 定时设置
- 0: 1小时
- 1: 2小时
- 2: 4小时
- 3: 6小时
- 4: 取消定时

## 错误处理

控制器包含完整的错误处理机制：
- 串口通信错误检测
- 数据帧校验和验证
- 超时处理
- 状态初始化检查
- **新增：多帧数据完整性检查**
- **新增：部分帧损坏时的错误恢复**

## 调试信息

控制器会输出详细的调试日志，包括：
- 数据帧发送/接收状态
- 设备状态变化
- 错误信息
- 通信协议解析结果
- **新增：多帧解析过程日志**
- **新增：每个数据帧的验证结果**

## 技术改进

### 多帧数据处理
1. **ReceiveMultiFrames**: 接收MCU上报的所有数据
2. **ParseMultiFrames**: 解析多个连续的数据帧
3. **自动分割**: 根据帧头自动分割多个数据帧
4. **独立验证**: 每个数据帧独立验证校验和
5. **协议常量**: 使用FRAME_HEADER等常量，避免硬编码

### 性能优化
- 使用vector容器管理多帧数据
- 支持任意数量的DP数据帧
- 错误恢复机制，部分帧损坏不影响其他帧处理
- 详细的调试日志便于问题排查

## 注意事项

1. 确保外部MCU正确连接到GPIO 17和GPIO 18
2. 外部MCU必须支持相同的通信协议
3. 首次使用前建议先调用状态查询功能
4. 控制命令发送后建议查询状态确认执行结果
5. 如果通信失败，检查串口连接和协议兼容性
6. **新增：MCU会一次性上报所有DP数据，系统会自动处理多帧数据**
7. **新增：支持部分帧损坏的情况，会继续处理后续有效帧** 